import{r as p,c1 as b,au as v}from"./index-D09qPjuF.js";const o=p(null);let a=null,r=null,i=!1;const f=new Set,d=new Set,W="wss://go.deeplink.cloud/websocket";let u=null,c=null,l=null;const w=()=>(u||(u=new Promise((e,n)=>{c=e,l=n})),u),T=()=>{var e;return((e=o.value)==null?void 0:e.readyState)===WebSocket.OPEN};function E(e){e.onopen=()=>{console.log("[WebSocket] ✅ 已连接"),c==null||c(),P(),d.forEach(n=>n())},e.onmessage=n=>{var s;if(n.data==="pong"){r&&clearTimeout(r);return}try{const t=JSON.parse(n.data);(s=t==null?void 0:t.result)!=null&&s.error&&console.warn("[WebSocket] ⚠️ 错误:",t.result.error),f.forEach(m=>m(n))}catch(t){console.error("[WebSocket] ❌ 消息解析失败:",t)}},e.onerror=n=>{console.error("[WebSocket] ❌ 出错:",n),l==null||l(n),S()},e.onclose=()=>{console.warn("[WebSocket] ⚠️ 已关闭"),l==null||l(new Error("WebSocket closed")),S()}}function g(){o.value||(u=new Promise((e,n)=>{c=e,l=n}),o.value=new WebSocket(W),E(o.value))}function P(){a&&clearInterval(a),a=setInterval(()=>{var e;((e=o.value)==null?void 0:e.readyState)===WebSocket.OPEN&&(o.value.send("ping"),r&&clearTimeout(r),r=setTimeout(()=>{var n;console.warn("[WebSocket] ❌ pong 未响应，主动关闭连接"),(n=o.value)==null||n.close()},3e4))},1e4)}function S(){i||(i=!0,clearInterval(a),clearTimeout(r),setTimeout(()=>{console.log("[WebSocket] 🔄 正在重连..."),o.value=null,g(),i=!1},5e3))}function y(e){const n=typeof e=="string"?e:JSON.stringify(e),s=()=>{var t;((t=o.value)==null?void 0:t.readyState)===WebSocket.OPEN?o.value.send(n):setTimeout(s,1e3)};s()}function I(e){f.add(e)}function O(e){f.delete(e)}function N(e){d.add(e)}function k(){var e;(e=o.value)==null||e.close(),clearInterval(a),clearTimeout(r),u=null,c=null,l=null}b()&&v(()=>{k()});function C(){return{socket:o,connect:g,send:y,onMessage:I,offMessage:O,onOpen:N,waitForReady:w,cleanup:k,isConnected:T}}export{C as u};
