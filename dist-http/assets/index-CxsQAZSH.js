var K=Object.defineProperty,Z=Object.defineProperties;var q=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var I=(n,e,o)=>e in n?K(n,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[e]=o,M=(n,e)=>{for(var o in e||(e={}))G.call(e,o)&&I(n,o,e[o]);if(D)for(var o of D(e))J.call(e,o)&&I(n,o,e[o]);return n},O=(n,e)=>Z(n,q(e));var g=(n,e,o)=>new Promise((T,h)=>{var x=u=>{try{N(o.next(u))}catch(v){h(v)}},C=u=>{try{N(o.throw(u))}catch(v){h(v)}},N=u=>u.done?T(u.value):Promise.resolve(u.value).then(x,C);N((o=o.apply(n,e)).next())});import{ao as W,aM as H,y as Q,p as V,u as X,h as Y,r as S,k as ee}from"./index-D09qPjuF.js";import{h as te,D as se,c as re}from"./decryptKeystore-vcF9PyHc.js";import{N as oe,g as $,u as b}from"./contracts-C6BXjFxA.js";import{p as ne}from"./units-C_OuvvnV.js";const ae=()=>W({method:"get",url:`${H}/api/cyc/getCrownInfo`}),ce=n=>W({method:"post",url:`${H}/api/cyc/saveBuyDLCOrder`,data:n}),ie=""+new URL("nfts-HrkAIZ3p.png",import.meta.url).href,we=Q("buyNft",()=>{const n=V(),{t:e}=X(),o=Y(),T=S(!0),h=S(null);let x=S([{price:"暂无数据",vertion:"暂无数据",percent:"0%",v:0}]);const C=()=>g(void 0,null,function*(){T.value=!0;const{data:t}=yield ae();T.value=!1,t.success&&t.content.length>0&&(console.log(t,"获取nfts列表数据"),h.value=t.date_text,x.value=t.content.map((r,l)=>{let a={0:1,1:3,2:6,3:12};const s=e("Store.nft.name"),p=e("Store.nft.price",{price:n.useLocalizedCurrency(r.price_usdt,2),month:a[l]}),c=e("Store.nft.vertion",{name:s,month:a[l]});return{price:p,vertion:c,percent:r.discount_test,v:n.useLocalizedCurrency(r.price_usdt*r.discount,2),type:r.expire_time_type}}))});function N(l){return g(this,arguments,function*({dlcAmount:t,saveData:r}){var m,d,w,y;console.log("购买nft购买nft购买nft购买nft");const{ensureWallet:a}=b(e),s=yield a();if(console.log(s,"resultresultresultresult"),!s)return;const{signer:p,address:c,dialog:i}=s,f=te(se,p);try{const F=yield f.decimals(),P=ne(String(t),F),L=yield(yield f.transfer(oe,P)).wait();if(L.status!==1)throw new Error("转账失败");const E=L.hash,R=L.blockNumber;console.log("✅ 交易哈希:",E),console.log("✅ 区块高度:",R);const j=yield p.signMessage(r.purchaser),{data:k}=yield ce(O(M({dlc_num:t},r),{blockNumber:R,hash:E,signature:j,invite_code:"",invite_wallet:""}));if(!k.success)throw new Error(k.message||"购买失败");(m=window.$message)==null||m.success(e("app.purchaseSuccess")),(d=i.destroy)==null||d.call(i)}catch(F){console.log(F,"errerr"),(w=window.$message)==null||w.error(F.message||e("app.purchaseFailed")),i.loading=!1,i.positiveText=e("app.confirm"),console.error("[NFT 购买出错]",F),(y=i.destroy)==null||y.call(i)}})}const u=S([]),v=ee(()=>u.value.length>0&&u.value.some(t=>t.NFTStatus==="activated")),_=S(!1);function B(t){if(t<=0)return"已过期";const r=Math.floor(t/(1e3*60*60*24)),l=Math.floor(t%(1e3*60*60*24)/(1e3*60*60)),a=Math.floor(t%(1e3*60*60)/(1e3*60));let s=[];return r>0&&s.push(`${r}${e("home.day")}`),(l>0||r>0)&&s.push(`${l}${e("home.hour")}`),s.push(`${a}${e("home.minute")}`),s.join("")}const A=()=>g(void 0,null,function*(){console.log("📥 正在从链上获取我的 NFT 列表..."),_.value=!0;try{const t=re(),r=$("NFT_CONTRACT",t),l=yield r.getTokenIdsByAddress(o.address);if(l.length===0){_.value=!1,u.value=[],console.log("✅ 当前钱包未持有任何 NFT");return}const a=Date.now(),s=[];for(const p of l){const c=Number(p),[i,f,m]=yield r.tokenId2NFTInfo(c),d=Number(m)*1e3,w=m>0?d>a?"activated":"expired":"notActivated";if(w==="expired"&&a-d>3*24*60*60*1e3){console.log(`💥 TokenId ${c} 已过期超3天，跳过`);continue}const y=d-a;s.push({tokenId:c,image:ie,version_type:Number(i),expire_type:Number(f),expire_time:d,NFTStatus:w,timeLeftText:w==="activated"?B(y):"—"})}_.value=!1,u.value=s,console.log("🎉 成功获取 NFT 列表:",s)}catch(t){console.error("❌ 获取我的 NFT 列表失败:",t),u.value=[]}});function U(t,r){return g(this,null,function*(){var f,m,d;const{ensureWallet:l}=b(e),a=yield l();if(!a)return;const{signer:s,address:p,dialog:c}=a,i=$("NFT_CONTRACT",s);try{if(console.log("🚀 开始转账 NFT",{tokenId:t,fromAddress:p,toAddress:r}),(yield(yield i["safeTransferFrom(address,address,uint256)"](p,r,t)).wait()).status!==1)throw new Error("NFT 购买失败");return(f=window.$message)==null||f.success(e("app.nftTransferSuccess")),(m=c.destroy)==null||m.call(c),!0}catch(w){console.error("[NFT 转账失败]",w),(d=window.$message)==null||d.error(e("app.nftPurchaseFailed")),c.loading=!1,c.positiveText=e("app.confirm")}})}function z(t){return g(this,null,function*(){var p,c,i;const{ensureWallet:r}=b(e),l=yield r();if(!l)return;const{signer:a,dialog:s}=l;try{const f=$("NFT_CONTRACT",a);if(console.log("🚀 正在激活 NFT:",t),(yield(yield f.active(t)).wait()).status!==1)throw new Error("激活失败");(p=window.$message)==null||p.success(e("app.nftActivationSuccess")),(c=s.destroy)==null||c.call(s),A()}catch(f){console.error("[激活 NFT 失败]",f),(i=window.$message)==null||i.error(e("app.nftActivationFailed")),s.loading=!1,s.positiveText=e("app.confirm")}})}return{getNftListH:C,nftList:x,nftListLoading:T,nftListEndTime:h,purchaseNFTFlow:N,getMyNftListH:A,myNftList:u,nftLoading:_,transferNFTFlow:U,activeNFTFlow:z,hasNft:v}});export{ie as _,we as u};
