var ze=Object.defineProperty,Ue=Object.defineProperties;var We=Object.getOwnPropertyDescriptors;var we=Object.getOwnPropertySymbols;var Ae=Object.prototype.hasOwnProperty,He=Object.prototype.propertyIsEnumerable;var ve=(n,e,t)=>e in n?ze(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,oe=(n,e)=>{for(var t in e||(e={}))Ae.call(e,t)&&ve(n,t,e[t]);if(we)for(var t of we(e))He.call(e,t)&&ve(n,t,e[t]);return n},he=(n,e)=>Ue(n,We(e));var g=(n,e,t)=>new Promise((o,a)=>{var c=u=>{try{f(t.next(u))}catch(h){a(h)}},i=u=>{try{f(t.throw(u))}catch(h){a(h)}},f=u=>u.done?o(u.value):Promise.resolve(u.value).then(c,i);f((t=t.apply(n,e)).next())});import{I as Je,ab as se,aa as S,a9 as M,d as Te,K as Ke,N as ye,aL as Ve,k as je,P as qe,l as R,F as Ce,r as w,o as Xe,c as Qe,b as P,w as W,f as A,s as _e,t as be,B as Ye,ao as De,aM as Ne,aN as Q,y as Ee,h as Le,u as $e,aO as Ze,p as et,i as tt,j as nt,a as at}from"./index-ChhltHVQ.js";import{g as ot,c as st,r as it,d as rt,e as ct,f as lt,h as dt,i as ut,j as pt,k as ft}from"./removeGeForceRTX-DO37ZxPc.js";import{g as H,C,a as ie,u as re}from"./contracts-C9jLvQn_.js";import{I as mt,c as ce}from"./decryptKeystore-vcF9PyHc.js";import{u as gt}from"./useGetDlcPrice-Cj32P7WO.js";import{c as wt}from"./transferToUsd-CHpIPDKe.js";import{u as vt}from"./useAppSocket-D0Jxy0CL.js";import{f as le}from"./units-C_OuvvnV.js";import{N as xe}from"./GradientText-CLZFWYbX.js";import{_ as ht}from"./Select-BHXx3xnx.js";import{d as _t,c as bt}from"./Grid-2xvDnFFT.js";const xt=Je("divider",`
 position: relative;
 display: flex;
 width: 100%;
 box-sizing: border-box;
 font-size: 16px;
 color: var(--n-text-color);
 transition:
 color .3s var(--n-bezier),
 background-color .3s var(--n-bezier);
`,[se("vertical",`
 margin-top: 24px;
 margin-bottom: 24px;
 `,[se("no-title",`
 display: flex;
 align-items: center;
 `)]),S("title",`
 display: flex;
 align-items: center;
 margin-left: 12px;
 margin-right: 12px;
 white-space: nowrap;
 font-weight: var(--n-font-weight);
 `),M("title-position-left",[S("line",[M("left",{width:"28px"})])]),M("title-position-right",[S("line",[M("right",{width:"28px"})])]),M("dashed",[S("line",`
 background-color: #0000;
 height: 0px;
 width: 100%;
 border-style: dashed;
 border-width: 1px 0 0;
 `)]),M("vertical",`
 display: inline-block;
 height: 1em;
 margin: 0 8px;
 vertical-align: middle;
 width: 1px;
 `),S("line",`
 border: none;
 transition: background-color .3s var(--n-bezier), border-color .3s var(--n-bezier);
 height: 1px;
 width: 100%;
 margin: 0;
 `),se("dashed",[S("line",{backgroundColor:"var(--n-color)"})]),M("dashed",[S("line",{borderColor:"var(--n-color)"})]),M("vertical",{backgroundColor:"var(--n-color)"})]),Rt=Object.assign(Object.assign({},ye.props),{titlePlacement:{type:String,default:"center"},dashed:Boolean,vertical:Boolean}),Tt=Te({name:"Divider",props:Rt,setup(n){const{mergedClsPrefixRef:e,inlineThemeDisabled:t}=Ke(n),o=ye("Divider","-divider",xt,Ve,n,e),a=je(()=>{const{common:{cubicBezierEaseInOut:i},self:{color:f,textColor:u,fontWeight:h}}=o.value;return{"--n-bezier":i,"--n-color":f,"--n-text-color":u,"--n-font-weight":h}}),c=t?qe("divider",void 0,a,n):void 0;return{mergedClsPrefix:e,cssVars:t?void 0:a,themeClass:c==null?void 0:c.themeClass,onRender:c==null?void 0:c.onRender}},render(){var n;const{$slots:e,titlePlacement:t,vertical:o,dashed:a,cssVars:c,mergedClsPrefix:i}=this;return(n=this.onRender)===null||n===void 0||n.call(this),R("div",{role:"separator",class:[`${i}-divider`,this.themeClass,{[`${i}-divider--vertical`]:o,[`${i}-divider--no-title`]:!e.default,[`${i}-divider--dashed`]:a,[`${i}-divider--title-position-${t}`]:e.default&&t}],style:c},o?null:R("div",{class:`${i}-divider__line ${i}-divider__line--left`}),!o&&e.default?R(Ce,null,R("div",{class:`${i}-divider__title`},this.$slots),R("div",{class:`${i}-divider__line ${i}-divider__line--right`})):null)}}),Re=Te({__name:"rentMachineDialog",setup(n,{expose:e}){const t=Lt(),o=w(null);e({formRef:o});const a=[{label:"10 minutes",value:600},{label:"20 minutes",value:1200},{label:"30 minutes",value:1800},{label:"40 minutes",value:2400},{label:"50 minutes",value:3e3},{label:"1 hour",value:3600},{label:"2 hours",value:7200}];return(c,i)=>{const f=Tt,u=ht,h=_t,B=Ye,T=bt;return Xe(),Qe(Ce,null,[P(f),P(T,{"label-placement":"left","label-width":"auto","require-mark-placement":"left",size:"medium",model:A(t).rentMachineDialogBeforeForm,ref_key:"formRef",ref:o},{default:W(()=>[P(h,{label:c.$t("gpu.rentalDuration"),path:"duration"},{default:W(()=>[P(u,{value:A(t).rentMachineDialogBeforeForm.duration,"onUpdate:value":[i[0]||(i[0]=J=>A(t).rentMachineDialogBeforeForm.duration=J),A(t).getRentPrice],options:a,placeholder:c.$t("gpu.selectRentalDuration")},null,8,["value","placeholder","onUpdate:value"])]),_:1},8,["label"]),P(h,{label:c.$t("gpu.approxEquivalent")},{default:W(()=>[P(B,{type:"primary",text:""},{default:W(()=>[_e(be(A(t).rentMachineDialogBeforeForm.price),1)]),_:1})]),_:1},8,["label"]),P(h,{label:c.$t("gpu.dlcAmount")},{default:W(()=>[P(B,{type:"primary",text:""},{default:W(()=>[_e(be(A(t).rentMachineDialogBeforeForm.dLCNumber)+" DLC",1)]),_:1})]),_:1},8,["label"])]),_:1},8,["model"])],64)}}}),yt=n=>De({method:"post",url:`${Ne}/api/cyc/getWalletRent`,data:n}),Vt=n=>De({method:"post",url:`${Ne}/api/cyc/deviceNotes`,data:n});function Ct(n){if(!n)return Q.unknown;const e=n.toLowerCase(),t={windows:"windows",macos:"macos",ubuntu:"ubuntu",debian:"debian",fedora:"fedora",redhat:"redhat",centos:"centos",arch:"arch",android:"android",ios:"ios",chromeos:"chromeos",opensuse:"opensuse",manjaro:"manjaro",linuxmint:"linuxmint",kali:"kali",alpine:"alpine",oraclelinux:"oraclelinux",raspbian:"raspbian",solaris:"solaris",freebsd:"freebsd",iphone:"iphone",huawei:"huawei",androidPhone:"androidPhone",unknown:"unknown"};for(const o in t)if(e.includes(o)){const a=t[o],c=Q[a];return c||(console.warn(`[getDeviceIcon] matched keyword "${o}", but iconMap["${a}"] not found`),Q.unknown)}return console.warn(`[getDeviceIcon] no keyword matched for deviceName: "${n}"`),Q.unknown}const Dt=Ee("deviceList",()=>{const n=w([]);let e=w(!1);const t=Le(),{t:o}=$e(),a=w(null);return{deviceList:n,getUserDeviceListH:()=>g(void 0,null,function*(){var f;e.value=!0;const{data:i}=yield yt({wallet:t.address});e.value=!1,i.success?(console.log(i,"JJJJJJJJJ"),n.value=i.content.map(u=>oe({name:u.os_release,icon:Ct(u.os_release),loading:!1},u))):(f=window.$message)==null||f.error(o("app.fetchUserRentalListFailed"))}),loading:e,userDeviceDetail:a}});function Nt(n){var a;const{t:e}=Ze.global,t=((n==null?void 0:n.message)||((a=n==null?void 0:n.error)==null?void 0:a.message)||"").toLowerCase(),o=JSON.stringify(n,null,2);return t.includes("already known")||t.includes("already imported")?{message:e("errors.alreadyKnown"),detail:o}:t.includes("insufficient funds for gas")||t.includes("insufficient funds")?{message:e("errors.insufficientDbc"),detail:o}:t.includes("nonce too low")?{message:e("errors.nonceTooLow"),detail:o}:t.includes("replacement fee too low")||t.includes("fee too low")?{message:e("errors.feeTooLow"),detail:o}:t.includes("underpriced")||t.includes("max fee per gas less than block base fee")?{message:e("errors.gasUnderpriced"),detail:o}:t.includes("execution reverted")?{message:e("errors.executionReverted"),detail:o}:t.includes("timeout")||t.includes("deadline")?{message:e("errors.timeout"),detail:o}:{message:e("errors.genericTxFailed"),detail:o}}function Et(n,e){var o;const t=(n==null?void 0:n.data)||((o=n==null?void 0:n.error)==null?void 0:o.data);if(!t)return null;try{const c=new mt(e).parseError(t);return(c==null?void 0:c.name)||null}catch(a){return null}}function de(n,e){var o,a,c,i;if(e!=null&&e.destroyPreviousToasts&&((o=window==null?void 0:window.$message)!=null&&o.destroyAll))try{window.$message.destroyAll()}catch(f){}if(e!=null&&e.abiForCustomError){const f=Et(n,e.abiForCustomError);if(e!=null&&e.nameToMessage){const u=e.nameToMessage(f);if(u){(a=window.$message)==null||a.error(u),console.warn("[detail]",JSON.stringify(n,null,2));return}}else if(f){(c=window.$message)==null||c.error(`合约拒绝执行（${f}）`),console.warn("[detail]",JSON.stringify(n,null,2));return}}const t=Nt(n);(i=window.$message)==null||i.error(t.message),console.warn("[detail]",t.detail)}function Y(c){return g(this,arguments,function*({provider:n,signerOrFrom:e,to:t,data:o,bufferPct:a=20}){var I,K,V;const i=typeof e=="string"?e:yield e.getAddress(),f=yield n.getFeeData(),u=(K=(I=f.maxFeePerGas)!=null?I:f.gasPrice)!=null?K:BigInt(0),h=(V=f.maxPriorityFeePerGas)!=null?V:BigInt(0),B={to:t,data:o,from:i};let T;typeof(e==null?void 0:e.estimateGas)=="function"?T=yield e.estimateGas(B):T=yield n.estimateGas(B);const J=BigInt(100+a),F=T*J/BigInt(100),O=F*u,G=yield n.getBalance(i);if(G<O){const j=new Error("insufficient funds for gas * price + value");throw j.code="INSUFFICIENT_FUNDS",j.txMeta={to:t,from:i,estGas:T.toString(),gasLimit:F.toString(),maxFeePerGas:u.toString()},j}return{from:i,gasLimit:F,maxFeePerGas:u,maxPriorityFeePerGas:h,estCost:O,balance:G}})}const Lt=Ee("cloud-computers",()=>{const n=et(),e=Le(),t=Dt(),o=tt();nt();const{t:a}=$e(),{connect:c,send:i,onMessage:f,waitForReady:u,onOpen:h,offMessage:B}=vt();let T=w(0);const J=()=>{T.value+=1},F=w(!1),O=w(500),G=w(0),I=w(0),K=w([{title:()=>R("div",{class:"dark:text-white font-bold"},"暂无数据"),num:0,canRentTrue:0,maxCalcPoint:0}]),V=()=>g(void 0,null,function*(){return yield ot()}),j=()=>g(void 0,null,function*(){var d;F.value=!0;const{data:l}=yield V();if(console.log(l,"OOOOOOOOO"),l.success){G.value=l.content.geo.ll[1],I.value=l.content.geo.ll[0];const{data:p}=yield st({distance:O.value,longitude:G.value,latitude:I.value});console.log(p,"MMMMMMMMM"),F.value=!1,p.success&&(K.value=p.content.map(r=>({title:()=>R("div",{class:"dark:text-white font-bold"},it(r._id)),type:r._id,num:r.total,canRentTrue:r.canRentTrue,maxCalcPoint:r.maxCalcPoint,canRentIntotal:()=>{}})))}else(d=window.$message)==null||d.error(a("app.fetchCurrentLocationFailed2"))}),ue=w([]),Z=w(!0),Me=l=>g(void 0,null,function*(){var p;Z.value=!0;const{data:d}=yield rt({distance:l.distance==="all"?"all":Number(O.value),longitude:l.longitude,latitude:l.latitude,gputype:l.type,pageSize:99999,page:1});Z.value=!1,d.success?(console.log(d,"根据gpu类型获取gpu列表"),ue.value=d.content.map(r=>{const _=`${((r.current_time+r.can_use_time*60*60*1e3-+new Date)/(1e3*60*60)).toFixed(2)} h`,v=()=>r.can_rent&&!r.is_rented?"vacant":!r.can_rent&&!r.is_rented?"notRentable":"rented";return he(oe({},r),{canUseTime:_,rsStatus:v,loading:!1})})):(p=window.$message)==null||p.error(a("app.fetchGpuListFailed2"))}),s=at({duration:600,price:"",dLCNumber:0,loading:!1,dlcprice:0,rentinfo:null}),Pe=(l,d)=>g(void 0,null,function*(){var r;const{data:p}=yield ct({machine_id:l});if(p.success)return console.log(p,"机器在线状态"),p.content?!0:((r=window.$message)==null||r.warning(a("gpu.offline")),d.loading=!1,!1)});function ee(){return g(this,null,function*(){const l=ce(),p=yield H("RENT",l).getMachinePrice(s.rentinfo.machine_id,s.duration),r=Number(le(p)),{dlc_price:m,waitReady:_}=gt();yield _(),s.dlcprice=m.value;const v=n.useLocalizedCurrency(wt(r,m.value));console.log(v,"价格",m.value,r),s.dLCNumber=Number(r.toFixed(5)),s.price=v})}const Fe=l=>g(void 0,null,function*(){var p;l.loading=!0,yield ee(),l.loading=!1;const d=w();(p=window.$dialog)==null||p.info({title:()=>R(xe,{size:24,type:"success",class:"font-bold"},{default:()=>a("gpu.rentalDetails")}),content:()=>R(Re,{ref:d}),class:"rounded-2xl dark:bg-[#1a1a1a] dark:text-white",showIcon:!1,negativeButtonProps:{color:"#3CD8A6",size:"medium"},positiveButtonProps:{color:"#03C188",size:"medium"},positiveText:a("gpu.confirm"),negativeText:a("app.cancel"),onPositiveClick:()=>g(void 0,null,function*(){fe({machineId:s.rentinfo.machine_id,rentSeconds:s.duration})})})}),pe=()=>g(void 0,null,function*(){yield pt({user_id:e.address,device_id:s.rentinfo.device_id,start_time:new Date().getTime(),rent_time:s.duration,display:{width:0,height:0,fps:0}}),i({id:1,method:"preconnect",token:e.token,params:{device_id:s.rentinfo.device_id,display:{width:1920,height:1080,fps:60}}})}),ke=()=>g(void 0,null,function*(){var d;const{data:l}=yield ft({rent_wallet:e.address,rent_satrtime:new Date().getTime(),rent_time:s.duration,os_release:"Windows 10 Version 20H2",device_id:s.rentinfo.device_id,machine_id:s.rentinfo.machine_id,rent_dlc:s.dLCNumber,rent_usdt:Number(s.dLCNumber*s.dlcprice),machine_info:s.rentinfo.machineInfo,rent_status:1,is_bind:!1});console.log(l,"租用后存储数据到数据库"),l.success&&(J(),(d=window.$message)==null||d.success(a("gpu.rentalSuccess")),o.push({name:"DeviceList"}))});function fe(p){return g(this,arguments,function*({machineId:l,rentSeconds:d}){const r=ce(),{ensureWallet:m}=re(a),_=yield m();if(!_)return;const{signer:v,address:D,dialog:N}=_;try{const y=H("RENT",r),k=H("DLC_TOKEN",r),E=yield y.canRent(l);if(console.log("[canRent]",E),!E)throw new Error(a("gpu.deviceUnavailable"));const L=yield y.getMachinePrice(l,d),x=Number(le(L)),b=yield k.balanceOf(D),X=Number(le(b));if(console.log("[价格]",{priceWei:L.toString(),price:x}),console.log("[余额]",{balanceWei:b.toString(),balance:X}),X<x)throw new Error(a("gpu.insufficientBalance"));const z={to:C.DLC_TOKEN,data:k.interface.encodeFunctionData("approve",[C.RENT,L])};yield Y({provider:r,signerOrFrom:v,to:z.to,data:z.data,bufferPct:20}),console.log("🚀 发起 approve 交易...");const $=yield(yield v.sendTransaction(z)).wait();if($.status!==1)throw new Error("授权失败，请稍后重试");console.log("✅ 授权成功:",$);const U={to:C.RENT,data:y.interface.encodeFunctionData("rentMachine",[l,d])};yield Y({provider:r,signerOrFrom:v,to:U.to,data:U.data,bufferPct:20}),console.log("🚀 发起 rentMachine 交易...");const q=yield(yield v.sendTransaction(U)).wait();if(q.status!==1)throw new Error("租用交易失败，请稍后重试");return yield pe(),yield ke(),N.destroy(),q.transactionHash}catch(y){console.error("[租用流程出错]",y),N.loading=!1,N.positiveText="确认",N.destroy(),de(y,{abiForCustomError:ie.RENT})}})}function Se(l){return g(this,null,function*(){var _,v;const{ensureWallet:d}=re(a),p=yield d();if(!p)return;const{signer:r,dialog:m}=p;try{m.loading=!0,m.positiveText=a("app.rentingOut");const D=H("RENT",r),N={to:C.RENT,data:D.interface.encodeFunctionData("endRentMachine",[l])};if((yield(yield r.sendTransaction(N)).wait()).status!==1)throw new Error("退租交易失败，请稍后重试");const{data:E}=yield lt({wallet:e.address,device_id:s.rentinfo.device_id,machine_id:s.rentinfo.machine_id});if(!E.success)throw new Error("提前结束租用api失败，请稍后重试");(_=window.$message)==null||_.success(a("app.releaseSuccess")),(v=m.destroy)==null||v.call(m),t.getUserDeviceListH()}catch(D){console.error("[退租失败]",D),m.loading=!1,m.positiveText=a("app.confirm")||"确认",de(D,{abiForCustomError:ie.RENT})}})}let te=w(!1);function Be(l){return g(this,null,function*(){var p,r,m,_;te.value=!0;const{data:d}=yield dt({machine_id:s.rentinfo.machine_id});if(d.success){let v=function(k,E){const L=Date.now(),b=k+E*1e3-L;return Math.max(Math.floor(b/1e3),0)};console.log(d.content,"机器信息");const D=d.content.current_time+d.content.can_use_time*60*60*1e3-+new Date,N=Number((D/(1e3*60)).toFixed(0)),y=v(d.content.rent_satrtime,d.content.rent_time);if(N<60){(p=window.$message)==null||p.warning(a("app.availableTimeTooShort"));return}else if(y<120){(r=window.$message)==null||r.warning(a("app.notEnoughTimeToRenew"));return}else{console.log(l,"info");const k=w();console.log(s,"rentMachineDialogBeforeForm"),yield ee(),console.log(s,"我是关键信息"),te.value=!1,(m=window.$dialog)==null||m.info({title:()=>R(xe,{size:24,type:"success",class:"font-bold"},{default:()=>a("gpu.rentalDetails")}),content:()=>R(Re,{ref:k}),class:"rounded-2xl dark:bg-[#1a1a1a] dark:text-white",showIcon:!1,negativeButtonProps:{color:"#3CD8A6",size:"medium"},positiveButtonProps:{color:"#03C188",size:"medium"},positiveText:a("gpu.confirm"),negativeText:a("app.cancel"),onPositiveClick:()=>g(this,null,function*(){var z,ne;const{ensureWallet:E}=re(a),L=yield E();if(!L)return;const{signer:x,dialog:b,address:X}=L;try{b.loading=!0,b.positiveText=a("app.renewing");const $=H("RENT",x),U=H("DLC_TOKEN",x),ae=x.provider||ce(),q=yield $.getMachinePrice(s.rentinfo.machine_id,s.duration);if((yield U.balanceOf(X))<q)throw new Error(a("gpu.insufficientBalance"));const me=U.interface.encodeFunctionData("approve",[C.RENT,q]);yield Y({provider:ae,signerOrFrom:x,to:C.DLC_TOKEN,data:me,bufferPct:20});const Oe={to:C.DLC_TOKEN,data:me};if(console.log("🚀 发起 approve 授权..."),(yield(yield x.sendTransaction(Oe)).wait()).status!==1)throw new Error("授权失败，请稍后重试");console.log("✅ 授权成功");const ge=$.interface.encodeFunctionData("renewRent",[s.rentinfo.machine_id,s.duration]);yield Y({provider:ae,signerOrFrom:x,to:C.RENT,data:ge,bufferPct:20});const Ge={to:C.RENT,data:ge};if(console.log("🚀 发起续租交易..."),(yield(yield x.sendTransaction(Ge)).wait()).status!==1)throw new Error("续租交易失败，请稍后重试");const{data:Ie}=yield ut({wallet:e.address,renew_time:s.duration,device_id:s.rentinfo.device_id,machine_id:s.rentinfo.machine_id,rent_dlc:s.dLCNumber,rent_usdt:Number(s.dLCNumber*s.dlcprice)});if(!Ie.success)throw new Error("续租入库失败，请稍后重试");yield pe(),(z=window.$message)==null||z.success(a("app.renewSuccess")),(ne=b.destroy)==null||ne.call(b),t.getUserDeviceListH()}catch($){console.error("[续租失败]",$),b.loading=!1,b.positiveText=a("app.confirm"),de($,{abiForCustomError:ie.RENT})}})})}}else(_=window.$message)==null||_.error(a("app.fetchRentalDetailsFailed"))})}return{getGpsH:V,getGpuTypeH:j,gpuTypeList:K,gpuTypeListLoading:F,getGpuListH:Me,distance:O,longitude:G,latitude:I,gpuList:ue,gpuListLoading:Z,rentMachineFlow:fe,rentMachineDialogBefore:Fe,rentMachineDialogBeforeForm:s,getRentPrice:ee,getMachineStatusH:Pe,RouterViewKey:T,endRentFlow:Se,renewRentFlow:Be,renewRentLoading:te}});export{Vt as a,Dt as b,Ct as g,Lt as u};
